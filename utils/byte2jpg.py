import sys
import os
from math import log
import numpy as np
import scipy as sp
from PIL import Image
import matplotlib.pyplot as plt
import pandas as pd

def saveimg(array,name,save_root):
    if array.shape[1]!=16:
        assert(False)
    b=int((array.shape[0]*16)**(0.5))
    b=2**(int(log(b)//log(2))+1)
    a=int(array.shape[0]*16/b)
    array=array[:int(a*b//16),:]
    array=np.reshape(array,(a,b))
    im = Image.fromarray(np.uint8(array)).resize((640,224))
    name=name.split(".")[0]
    save_name=save_root+name+".jpg"
    im.save(save_name,"JPEG")

if __name__ =="__main__":

    data_root="D:/Chrome Download/"
    origin_data_filename="train/train/"
    save_data_filename="malware_images/"

    origin_data_path=data_root+origin_data_filename
    save_data_path=data_root+save_data_filename

    labelPath="D:/Chrome Download/trainLabels.csv"

    label_df=pd.read_csv(labelPath)
    label_value=label_df.values
    label_dict={}

    for filename,label in label_value:
        label_dict[filename]=label
    files = os.listdir(origin_data_path)
    c = 0

    for cc, x in enumerate(files):
        if '.bytes' != x[-6:]:
            continue
        try:
            x_name=x.split(".")[0]
            x_label=label_dict[x_name]
            save_data_subpath=save_data_path+"{}/".format(x_label)
            if not os.path.exists(save_data_subpath):
                os.makedirs(save_data_subpath)

            f = open(origin_data_path + x)
            array = []
            c += 1
            for line in f:
                xx = line.split()
                if len(xx) != 17:
                    continue
                array.append([int(i, 16) if i != '??' else 0 for i in xx[1:]])
            saveimg(np.array(array), x, save_data_subpath)
            del array
            f.close()
            print("{} file is ok".format(x))
        except:
            with open("D:/Tutor/Uncomplete/malware/wrong_file.txt","a") as F:
                F.writelines("{} file is wrong\n".format(x))
            F.close()
            print("{} file is wrong".format(x))


